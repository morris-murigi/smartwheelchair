<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Smart Wheelchair Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Chart.js CDN for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Link to external stylesheet -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <header>
        <h1>üöÄ Smart Wheelchair Dashboard</h1>
        <p>Live Data from ESP32 Sensors | Last Updated: <span id="last-updated">{{ data[0][6] if data else 'Awaiting data' }}</span></p>
    </header>

    <main>
        {% if data %}
        <!-- Hidden div to hold initial JSON data -->
        <div id="sensor-data" data-sensor='{{ data | tojson | safe }}' style="display: none;"></div>

        <!-- Overview Cards -->
        <section class="overview" id="overview">
            <div class="card">
                <h3>Pitch & Roll</h3>
                <p class="value" id="pitch-roll">{{ "%.2f"|format(data[0][1]) }}¬∞ / {{ "%.2f"|format(data[0][2]) }}¬∞</p>
                <div class="gauge"></div>
                <p id="tilt-status" {% if data[0][1] | abs > 10 or data[0][2] | abs > 10 %}style="color: red;"{% endif %}>
                    {{ 'Tilted' if data[0][1] | abs > 10 or data[0][2] | abs > 10 else 'Stable' }}
                </p>
            </div>
            <div class="card">
                <h3>Gas Level</h3>
                <p class="value" id="gas-level">{{ "%.2f"|format(data[0][3]) }}</p>
                <div class="gauge"></div>
                <p id="gas-status" {% if data[0][3] > 100 %}style="color: red;"{% endif %}>
                    {{ 'High' if data[0][3] > 100 else 'Safe' }}
                </p>
            </div>
            <div class="card">
                <h3>UV Index</h3>
                <p class="value" id="uv-index">{{ "%.2f"|format(data[0][4]) }}</p>
                <div class="gauge"></div>
                <p id="uv-status" {% if data[0][4] > 3 %}style="color: red;"{% endif %}>
                    {{ 'High' if data[0][4] > 3 else 'Low' }}
                </p>
            </div>
            <div class="card">
                <h3>Alert Status</h3>
                <p class="value {{ 'alert-true' if data[0][5] else 'alert-false' }}" id="alert-status">
                    {{ '‚ö†Ô∏è Yes' if data[0][5] else '‚úÖ No' }}
                </p>
            </div>
        </section>

        <!-- Graphs Section -->
        <section class="graphs">
            <div class="graph-container">
                <h2>Pitch & Roll Over Time</h2>
                <canvas id="pitchRollChart"></canvas>
            </div>
            <div class="graph-container">
                <h2>Gas Level Over Time</h2>
                <canvas id="gasChart"></canvas>
            </div>
            <div class="graph-container">
                <h2>UV Index Over Time</h2>
                <canvas id="uvChart"></canvas>
            </div>
        </section>

        <!-- Data Table -->
        <table id="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Pitch (¬∞)</th>
                    <th>Roll (¬∞)</th>
                    <th>Gas Level</th>
                    <th>UV Index</th>
                    <th>Alert</th>
                    <th>Timestamp</th>
                </tr>
            </thead>
            <tbody id="table-body">
                {% for row in data %}
                <tr>
                    <td>{{ row[0] }}</td>
                    <td>{{ "%.2f"|format(row[1]) }}</td>
                    <td>{{ "%.2f"|format(row[2]) }}</td>
                    <td>{{ "%.2f"|format(row[3]) }}</td>
                    <td>{{ "%.2f"|format(row[4]) }}</td>
                    <td class="{{ 'alert-true' if row[5] else 'alert-false' }}">
                        {{ '‚ö†Ô∏è Yes' if row[5] else '‚úÖ No' }}
                    </td>
                    <td>{{ row[6] }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="no-data">
            <h2>No Data Available</h2>
            <p>Awaiting sensor data from ESP32. Please check your device connection.</p>
        </div>
        {% endif %}
    </main>

    <footer>
        ¬© 2025 Smart Wheelchair | Powered by Flask + Render
    </footer>

    <!-- JavaScript for Polling, Charts, and Alerts -->
    <script>
        // Initialize charts
        let pitchRollChart, gasChart, uvChart;
        let lastTimestamp = null; // Track latest timestamp to avoid duplicate alerts

        function initializeCharts(data) {
            const labels = data.map(row => row.timestamp);
            const pitchData = data.map(row => row.pitch);
            const rollData = data.map(row => row.roll);
            const gasData = data.map(row => row.gas_level);
            const uvData = data.map(row => row.uv_index);

            // Destroy existing charts to prevent memory leaks
            if (pitchRollChart) pitchRollChart.destroy();
            if (gasChart) gasChart.destroy();
            if (uvChart) uvChart.destroy();

            // Pitch & Roll Chart
            pitchRollChart = new Chart(document.getElementById('pitchRollChart'), {
                type: 'line',
                data: {
                    labels: labels.reverse(),
                    datasets: [
                        { label: 'Pitch (¬∞)', data: pitchData.reverse(), borderColor: '#0077cc', fill: false },
                        { label: 'Roll (¬∞)', data: rollData.reverse(), borderColor: '#00cc77', fill: false }
                    ]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { position: 'top' } }
                }
            });

            // Gas Level Chart
            gasChart = new Chart(document.getElementById('gasChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{ label: 'Gas Level', data: gasData.reverse(), borderColor: '#ff9900', fill: false }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { position: 'top' } }
                }
            });

            // UV Index Chart
            uvChart = new Chart(document.getElementById('uvChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{ label: 'UV Index', data: uvData.reverse(), borderColor: '#cc00ff', fill: false }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { position: 'top' } }
                }
            });
        }

        // Update UI with new data
        function updateDashboard(data) {
            if (data.length === 0) {
                document.getElementById('overview').style.display = 'none';
                document.getElementById('data-table').style.display = 'none';
                document.querySelector('.no-data') || document.querySelector('main').insertAdjacentHTML('beforeend', `
                    <div class="no-data">
                        <h2>No Data Available</h2>
                        <p>Awaiting sensor data from ESP32. Please check your device connection.</p>
                    </div>
                `);
                return;
            }

            // Show sections
            document.getElementById('overview').style.display = 'flex';
            document.getElementById('data-table').style.display = 'table';
            document.querySelector('.no-data')?.remove();

            // Update cards
            const latest = data[0];
            document.getElementById('last-updated').textContent = latest.timestamp;
            document.getElementById('pitch-roll').textContent = `${latest.pitch.toFixed(2)}¬∞ / ${latest.roll.toFixed(2)}¬∞`;
            document.getElementById('tilt-status').textContent = Math.abs(latest.pitch) > 10 || Math.abs(latest.roll) > 10 ? 'Tilted' : 'Stable';
            document.getElementById('tilt-status').style.color = Math.abs(latest.pitch) > 10 || Math.abs(latest.roll) > 10 ? 'red' : '';
            document.getElementById('gas-level').textContent = latest.gas_level.toFixed(2);
            document.getElementById('gas-status').textContent = latest.gas_level > 100 ? 'High' : 'Safe';
            document.getElementById('gas-status').style.color = latest.gas_level > 100 ? 'red' : '';
            document.getElementById('uv-index').textContent = latest.uv_index.toFixed(2);
            document.getElementById('uv-status').textContent = latest.uv_index > 3 ? 'High' : 'Low';
            document.getElementById('uv-status').style.color = latest.uv_index > 3 ? 'red' : '';
            document.getElementById('alert-status').textContent = latest.alert ? '‚ö†Ô∏è Yes' : '‚úÖ No';
            document.getElementById('alert-status').className = latest.alert ? 'value alert-true' : 'value alert-false';

            // Update table
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = data.map(row => `
                <tr>
                    <td>${row.id}</td>
                    <td>${row.pitch.toFixed(2)}</td>
                    <td>${row.roll.toFixed(2)}</td>
                    <td>${row.gas_level.toFixed(2)}</td>
                    <td>${row.uv_index.toFixed(2)}</td>
                    <td class="${row.alert ? 'alert-true' : 'alert-false'}">${row.alert ? '‚ö†Ô∏è Yes' : '‚úÖ No'}</td>
                    <td>${row.timestamp}</td>
                </tr>
            `).join('');

            // Check for alerts on new data only
            if (latest.timestamp !== lastTimestamp && data.length > 0) {
                let alertMessages = [];
                if (Math.abs(latest.pitch) > 10 || Math.abs(latest.roll) > 10) {
                    alertMessages.push(`High Tilt Detected: Pitch ${latest.pitch.toFixed(2)}¬∞, Roll ${latest.roll.toFixed(2)}¬∞`);
                }
                if (latest.gas_level > 100) {
                    alertMessages.push(`High Gas Level: ${latest.gas_level.toFixed(2)}`);
                }
                if (latest.uv_index > 3) {
                    alertMessages.push(`High UV Index: ${latest.uv_index.toFixed(2)}`);
                }
                if (latest.alert) {
                    alertMessages.push(`ESP32 Alert Triggered`);
                }
                if (alertMessages.length > 0) {
                    alert(`üö® Warning at ${latest.timestamp}:\n${alertMessages.join('\n')}`);
                }
                lastTimestamp = latest.timestamp; // Update to prevent repeat alerts
            }

            // Update charts
            initializeCharts(data);
        }

        // Initial chart setup
        const sensorElement = document.getElementById('sensor-data');
        let initialData = [];
        if (sensorElement) {
            initialData = JSON.parse(sensorElement.dataset.sensor).map(row => ({
                id: row[0],
                pitch: row[1],
                roll: row[2],
                gas_level: row[3],
                uv_index: row[4],
                alert: row[5],
                timestamp: row[6]
            }));
            lastTimestamp = initialData.length > 0 ? initialData[0].timestamp : null;
            initializeCharts(initialData);
        }

        // Polling function
        function pollData() {
            fetch('/api/latest')
                .then(response => response.json())
                .then(result => updateDashboard(result.data))
                .catch(error => console.error('Polling error:', error));
        }

        // Start polling every 10 seconds
        setInterval(pollData, 10000);
        // Initial poll on load
        pollData();
    </script>
</body>
</html>